# 16 InlineHook补丁技术
* 认识Inline HOOK
其实在之前学习硬件HOOK的时候，我们已经自行了解过了。
1. HOOK的分类：Inline HOOK，APIHOOK,，IATHOOK，硬件HOOK
2. 什么是InlineHOOK
	>通过修改汇编代码从而实现修改程序执行流程
3. 易语言里的超级HOOK是什么？
	>是InlineHOOK的一种，可以对任意地址进行HOOK
	>易语言外挂作者常常称这种HOOK技术为超级HOOK


* 示例：利用InlineHOOK给程序添加信息框

OD分析易语言程序的时候，最好同时使用E-Debug_20.dll（包含CodeMake.exe），和E-Debug_302.dll两个插件。先使用E-Debug_20.dll，再点击使用E-Debug_302.dll！如果发现E-Debug_20.dll弹窗使用不了，那就在Alt+M内存窗口中查看找到，当前的内存地址开始(基址)和偏移的大小是多少，再回来填入弹框即可！

如下图，假如在下原本点击按钮只是会修改窗口标题的程序的按钮事件ff55fc5f5e下断点，我们需要通过lnlinehook技术，让它可以增加弹窗功能，F7跟踪得到如下图，我们想要在画红框的地方，进行jmp到一个全部为0的地方。
{为什么会有大片00的地方呢？原来PE文件有对齐机制}
![[Pasted image 20240204161429.png]]

![[Pasted image 20240204161440.png]]
```
//从右往左压入参数
int MessageBox(
  [in, optional] HWND    hWnd,
  [in, optional] LPCTSTR lpText,
  [in, optional] LPCTSTR lpCaption,
  [in]           UINT    uType
);
```
![[Pasted image 20240204161831.png]]
![[Pasted image 20240204180137.png]]
然后在那个地方开始编写自己的代码。最后要思考，怎么恢复被我们的jmp覆盖掉的原来的指令？其实在空白处的最后写回去再jmp回到原来的下面的地址就行。最后保存执行效果如下图：
![[Pasted image 20240204180220.png]]

课堂中，NCK老师还演示了`通用DLL注入器`的使用，是由易语言写的一个小工具，再拿个样例程序，看OD中找到个可以HOOK的地址，然后借助画眉(NCK)老师的`画眉HOOK模块`来编译个dll，最后借助`通用DLL注入器`选择dll--》选择注入进程。

* 上节课`小生帝王CM2无壳无VM`作业讲解
有了上面的知识铺垫，那么再分析这个程序，发现按钮事件后，看E-debug的注释call好像什么也没有做，那再哪里进行了关键比较呢？猜测有API被HOOK了，比较应该是再某个HOOK后的函数内进行的！

小tips：可以使用火绒剑或者pchunter等工具查看`钩子扫描`
![[Pasted image 20240204214437.png]]
还有字节集的概念，在内存中是个结构体，包含（编号，数据大小几个字节，几个字节的数据）
![[Pasted image 20240204223804.png]]


>如下分析：
HOOK（有两个，前面那个在内部比较了两个内部的字符串不相等就跳过了一大段比较，后面那个内部比较了两个内部的字符串相等才是继续判断对比注册码）（其实就是自我判断是否为第一个call，如果是就不进行比较）-->创建线程--》用线程判断注册码
第一步，下断点按钮事件
第二步，发现按钮事件内部都只有读取组件属性和设置组件属性，没有自定义函数吗？
第三步，跟踪其中一个设置组件属性的call，F7后一直F8
第四步，F8到一个地方，很类似于上面dll注入使用的HOOK，是个jmp
第五步，跟踪这个jmp，发现HOOK后是创建线程
第六步，跟踪这个线程，就可以来到算法处
第七步。借助E-debug分析算法。
![[Pasted image 20240204214447.png]]

![[Pasted image 20240204214454.png]]

![[Pasted image 20240204214507.png]]

![[Pasted image 20240204214513.png]]

![[Pasted image 20240204214519.png]]

![[Pasted image 20240204214527.png]]

![[Pasted image 20240204214540.png]]

![[Pasted image 20240205104832.png]]

最后跟踪算法到最后！nop一些跳转，成功实现破解，而且逆出注册码：`牧牛论坛      bbs.92fzb.com`
最后留下的作业，用lilineHook技术实现音乐的播放，关键的API就是`mciSendString`
