# 三个IDA重要关键技巧
## 1. 关于IDA中JMPOUT的修复方法
如下图所示这段函数的汇编代码，明明是有两个printf，但是F5的时候竟然会一个识别成JMPOUT？？？


![[Pasted image 20240227140615.png]]
![[Pasted image 20240227140625.png]]
ps: 上节课我们学习给printf添加调试符号，发现添加不到，在VS中F12跟踪printf函数，原来他是直接以源码方式给我们的，不是静态库，所以没签名sig。所以上面的call printf 是我根据经验在IDA中按n键重命名的。

其实造成上述原因的就是其中的这三行代码：因为IDA是线性扫描的。这三句以后就会都无法识别
```
.text:0040109D                 mov     eax, offset loc_4010A8
.text:004010A2                 mov     [ebp+var_4], eax
.text:004010A5                 jmp     [ebp+var_4]
```
要修改可以如果是连贯的直接nop即可。也可以jmp 004010A8

以后肯定会遇到jmpout记得要学会改


## 2. FakeRetValue--欺骗IDA,错误的返回值
如下图，在IDA中还经常会遇到这样一个突然出现的变量也没赋值，如下图
![[Pasted image 20240227143654.png]]
如下图所示，分析函数的汇编代码才知道，这里有个函数是以edx作为返回值，edx=3，但是正常的函数结果返回值都是用eax，所以IDA不能识别函数调用约定
![[Pasted image 20240227143701.png]]
![[Pasted image 20240227143748.png]]

修复方式如下图，按y，然后修改为修改 `int __usercall ret_edx_3<edx>()`
改成功后如下图：
![[Pasted image 20240227144234.png]]

![[Pasted image 20240227144239.png]]

## 3. sp-analysis failed--修复方法
先看汇编代码如下所示：
![[Pasted image 20240227144815.png]]
有红色的字sp-analysis failed，在下面按F5报错，和在上面按F5后双击sub_40109c进不去，示例如下
![[Pasted image 20240227144943.png]]
提示我们堆栈有问题，就是典型的堆栈不平衡，在Options-->General-->Disassmbly-->勾选Stack pointer就可以显示堆栈如下图，有负数，不平衡。
应该选择最下面的000然后Alk+K改成和下一句一样。
![[Pasted image 20240227145349.png]]

但是还是一样没办法解决
其实这两个是一个函数只不过被IDA识别成了两个，导致堆栈不平衡，可以选中sub_40109c按u设置为未定义，然后按c识别为代码，最后在004010BC的retn按e(Edit-->functions-->set function end)即可识别为一个函数，最后按F5如下图：
![[Pasted image 20240227150343.png]]
其实就算是这两行代码导致的，直接nop即可：
```
.text:00401096 054                 call    loc_40109C
.text:0040109B 054                 retn
```

![[Pasted image 20240227151436.png]]
修复成功
![[Pasted image 20240227151520.png]]

课程最后还演示了一下VM1.70.4把包含按钮事件的整个函数vm后怎么还原。哈哈哈画眉老师是直接赋值其他程序的call函数一大段复制粘贴过来了也能跑哈哈哈。大片红色可以点击删除备份，从模块中删除分析，只是相差比较大的程序时候里面哪个call的地址可能不一样，需要到另个程序的call里去看看提取特征码，然后到被vm的程序里面搜索，得到地址然后修改粘贴过来的代码的call.
其实这之前讲过就是绕vm的方法之一。

这节课最后是希望让我们理解HOOK的C语言代码--编写易于语言分析工具 ，见附件


# 重载易语言内核绕过VM
承接上节课对VM的操作。
插件StrongOD有InjectDLL功能Remote Thread注入dll
当我们在易语言编写一个包含按钮的示例程序，然后在VM中把包含易语言按钮事件特征码的整个函数VM掉，（上节课是可以用相似的程序进行）
